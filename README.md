# Casino & Game Provider Integration

Bidirectional API integration between an online Casino Platform and an external Game Provider (Jaqpot Games). Both systems coexist in a single codebase with logical separation: namespaced endpoints (`/casino/*`, `/provider/*`) and prefixed database tables (`casino_*`, `provider_*`).

The Casino is the **sole source of truth** for wallet balances. The Provider never reads or writes balances directly — all balance mutations happen exclusively through signed Casino callback APIs (`/casino/debit`, `/casino/credit`, `/casino/rollback`). Every money-moving operation is **atomic** (Prisma interactive transactions) and **strictly idempotent** (unique `external_transaction_id` per request with cached responses).

## Tech Stack

- **Runtime:** Node.js v18+
- **Language:** TypeScript
- **Framework:** Express.js
- **Database:** PostgreSQL
- **ORM:** Prisma 7
- **Package Manager:** pnpm

## Setup

```bash
# 1. Install dependencies
pnpm install

# 2. Configure environment
cp .env.example .env
# Edit .env with your PostgreSQL credentials if needed

# 3. Generate Prisma client
pnpm prisma:generate

# 4. Run database migrations
pnpm prisma:migrate

# 5. Seed demo data (2 users, 2 games, provider config)
pnpm seed

# 6. Start the server
pnpm dev
```

## Environment Variables

| Variable          | Description                        |
|-------------------|------------------------------------|
| `DATABASE_URL`    | PostgreSQL connection string       |
| `PORT`            | Server port (default: `3000`)      |
| `CASINO_SECRET`   | HMAC secret for casino callbacks   |
| `PROVIDER_SECRET` | HMAC secret for provider endpoints |

## Run a Full Simulation

With the server running:

```bash
pnpm simulate
```

Or with curl:

```bash
curl -X POST http://localhost:3000/casino/simulateRound \
  -H "Content-Type: application/json" \
  -d '{"userId": 1, "gameId": 1}'
```

### Expected Simulation Output

Starting balance: `1,000,000` cents ($10,000.00)

| Step | Action | Amount | Balance After | Validates |
|------|--------|--------|---------------|-----------|
| 1 | Balance check | -- | 1,000,000 | Read-only query |
| 2 | Bet 1 (debit) | -1,000 | 999,000 | Atomic debit |
| 3 | Bet 2 (debit) | -1,000 | 998,000 | Atomic debit |
| 4 | Rollback bet 2 | +1,000 | 999,000 | Reversal of bet 2 |
| 5 | Payout (credit) | +2,000 | 1,001,000 | 2x bet 1 winnings |
| 6 | Final balance check | -- | 1,001,000 | Confirms integrity |
| 7 | Idempotency retry (bet 1) | 0 | 1,001,000 | Cached response, no double-charge |
| 8 | Tombstone rollback | 0 | 1,001,000 | Marker for non-existent original |
| 9 | Rejected rollback | -- | 1,001,000 | Denied: round has payout |

Final balance: `1,001,000` cents ($10,010.00) — net profit of $10.00.

## API Endpoints

### Casino APIs

| Endpoint | Description | Auth |
|----------|-------------|------|
| `POST /casino/launchGame` | Validates player/wallet, creates session, calls `/provider/launch` | None (client) |
| `POST /casino/simulateRound` | Orchestrates launch + full provider simulation | None (client) |
| `POST /casino/getBalance` | Returns authoritative player balance (read-only) | HMAC `x-casino-signature` |
| `POST /casino/debit` | Deducts funds for a bet (atomic, idempotent) | HMAC `x-casino-signature` |
| `POST /casino/credit` | Credits funds for a payout (atomic, idempotent) | HMAC `x-casino-signature` |
| `POST /casino/rollback` | Reverses a previously accepted bet (atomic, idempotent) | HMAC `x-casino-signature` |

### Provider APIs

| Endpoint | Description | Auth |
|----------|-------------|------|
| `POST /provider/launch` | Creates provider-side session and player mapping | HMAC `x-provider-signature` |
| `POST /provider/simulate` | Runs scripted demo round calling casino callbacks | HMAC `x-provider-signature` |

## Security Model (HMAC-SHA256)

Each direction of communication uses its own dedicated secret and header:

| Direction | Header | Secret |
|-----------|--------|--------|
| Provider -> Casino (`/casino/*`) | `x-casino-signature` | `CASINO_SECRET` |
| Casino -> Provider (`/provider/*`) | `x-provider-signature` | `PROVIDER_SECRET` |

The request body is serialized with `JSON.stringify()` and signed using HMAC-SHA256. Verification uses `crypto.timingSafeEqual()` for constant-time comparison, preventing timing attacks.

## Idempotency

All money-moving endpoints (`/casino/debit`, `/casino/credit`, `/casino/rollback`) enforce strict idempotency:

- Each request carries a unique `transactionId` generated by the Provider.
- Before processing, the Casino checks `casino_transactions.external_transaction_id` (UNIQUE constraint).
- If found, the original cached response (`response_cache` JSONB column) is returned immediately — no balance mutation occurs.
- If not found, the transaction is processed atomically and the response is cached.

This guarantees that provider retries (due to timeouts or network errors) never cause double-charges or double-payouts. The simulation can be safely re-run since each invocation generates new UUIDs for all transaction IDs.

## Rollback Rules

- **Only bets (debits) can be rolled back.** Attempting to rollback a credit returns HTTP 400.
- **No rollback after payout.** If the round already has a credit transaction, rollback is denied with HTTP 400.
- **Tombstone rule:** If the original bet transaction cannot be found, a rollback marker is recorded with `amount=0` and the response includes `"tombstone": true`. Balance remains unchanged. This provides auditability and prevents inconsistent retry behavior.
- **Idempotent:** Duplicate rollback requests (same `transactionId`) return the cached first response.

## Full Round Flow

### Step 0: Client triggers simulation

**`POST /casino/simulateRound`** (no auth — client-initiated)

```json
// Request
{ "userId": 1, "gameId": 1 }
```

Casino creates a game session and calls the Provider:

### Step 0a: Casino calls Provider launch

**`POST /provider/launch`** | Header: `x-provider-signature`

```json
// Request
{
  "sessionToken": "7f325788-c990-432c-b7b0-7dcbdd4e5101",
  "casinoSessionId": 1,
  "userId": 1,
  "gameId": "SLOTS_001",
  "currency": "USD",
  "casinoCode": "JAQPOT"
}

// Response 200
{
  "providerSessionId": "788b3ad9-daf4-40ad-84df-fafcaa277285",
  "gameId": "SLOTS_001",
  "currency": "USD",
  "minBet": "1000",
  "maxBet": "100000",
  "playerId": 1
}
```

Casino stores `providerSessionId` in the session, then calls Provider simulate:

### Step 0b: Casino calls Provider simulate

**`POST /provider/simulate`** | Header: `x-provider-signature`

```json
// Request
{
  "sessionToken": "7f325788-c990-432c-b7b0-7dcbdd4e5101",
  "providerSessionId": "788b3ad9-daf4-40ad-84df-fafcaa277285",
  "userId": 1,
  "gameId": "SLOTS_001",
  "currency": "USD",
  "casinoCode": "JAQPOT"
}
```

Provider creates a game round and executes the following steps:

---

### Step 1: Balance check

**`POST /casino/getBalance`** | Header: `x-casino-signature`

```json
// Request
{ "sessionToken": "7f325788-c990-432c-b7b0-7dcbdd4e5101", "userId": 1 }

// Response 200
{ "userId": 1, "balance": "1000000", "currency": "USD" }
```

Balance: **1,000,000** (no mutation)

---

### Step 2: Bet 1 (debit)

**`POST /casino/debit`** | Header: `x-casino-signature`

```json
// Request
{
  "sessionToken": "7f325788-c990-432c-b7b0-7dcbdd4e5101",
  "userId": 1,
  "transactionId": "a9429bb3-9f71-4497-9fa4-f5f7592a46af",
  "roundId": "971faf2a-1b1a-45da-82dd-fc1e202134e3",
  "amount": 1000
}

// Response 200
{
  "transactionId": "a9429bb3-9f71-4497-9fa4-f5f7592a46af",
  "balance": "999000",
  "currency": "USD",
  "status": "ok"
}
```

Balance: 1,000,000 - 1,000 = **999,000**

---

### Step 3: Bet 2 (debit)

**`POST /casino/debit`** | Header: `x-casino-signature`

```json
// Request
{
  "sessionToken": "7f325788-c990-432c-b7b0-7dcbdd4e5101",
  "userId": 1,
  "transactionId": "bfcb7fbd-9593-4baa-9d4b-713f7cbf98fd",
  "roundId": "971faf2a-1b1a-45da-82dd-fc1e202134e3",
  "amount": 1000
}

// Response 200
{
  "transactionId": "bfcb7fbd-9593-4baa-9d4b-713f7cbf98fd",
  "balance": "998000",
  "currency": "USD",
  "status": "ok"
}
```

Balance: 999,000 - 1,000 = **998,000**

---

### Step 4: Rollback bet 2

**`POST /casino/rollback`** | Header: `x-casino-signature`

```json
// Request
{
  "sessionToken": "7f325788-c990-432c-b7b0-7dcbdd4e5101",
  "userId": 1,
  "transactionId": "06390e80-c6d9-46ea-a4f2-b09c6afbe795",
  "roundId": "971faf2a-1b1a-45da-82dd-fc1e202134e3",
  "originalTransactionId": "bfcb7fbd-9593-4baa-9d4b-713f7cbf98fd"
}

// Response 200
{
  "transactionId": "06390e80-c6d9-46ea-a4f2-b09c6afbe795",
  "balance": "999000",
  "currency": "USD",
  "status": "ok"
}
```

Balance: 998,000 + 1,000 = **999,000** (bet 2 reversed)

---

### Step 5: Payout (credit)

**`POST /casino/credit`** | Header: `x-casino-signature`

```json
// Request
{
  "sessionToken": "7f325788-c990-432c-b7b0-7dcbdd4e5101",
  "userId": 1,
  "transactionId": "ae401783-763b-4ce0-8089-7a6c7b62f0a4",
  "roundId": "971faf2a-1b1a-45da-82dd-fc1e202134e3",
  "amount": 2000,
  "relatedTransactionId": "a9429bb3-9f71-4497-9fa4-f5f7592a46af"
}

// Response 200
{
  "transactionId": "ae401783-763b-4ce0-8089-7a6c7b62f0a4",
  "balance": "1001000",
  "currency": "USD",
  "status": "ok"
}
```

Balance: 999,000 + 2,000 = **1,001,000** (2x bet 1 winnings)

---

### Step 6: Final balance check

**`POST /casino/getBalance`** | Header: `x-casino-signature`

```json
// Request
{ "sessionToken": "7f325788-c990-432c-b7b0-7dcbdd4e5101", "userId": 1 }

// Response 200
{ "userId": 1, "balance": "1001000", "currency": "USD" }
```

Balance confirmed: **1,001,000**

---

### Step 7: Idempotency test — retry bet 1

**`POST /casino/debit`** | Header: `x-casino-signature`

Same `transactionId` as Step 2. Casino detects the duplicate and returns the cached response without mutating the balance.

```json
// Request (identical to Step 2)
{
  "sessionToken": "7f325788-c990-432c-b7b0-7dcbdd4e5101",
  "userId": 1,
  "transactionId": "a9429bb3-9f71-4497-9fa4-f5f7592a46af",
  "roundId": "971faf2a-1b1a-45da-82dd-fc1e202134e3",
  "amount": 1000
}

// Response 200 (cached from Step 2)
{
  "transactionId": "a9429bb3-9f71-4497-9fa4-f5f7592a46af",
  "balance": "999000",
  "currency": "USD",
  "status": "ok"
}
```

Actual balance after retry: **1,001,000** (unchanged — idempotency verified)

---

### Step 8: Tombstone rollback

**`POST /casino/rollback`** | Header: `x-casino-signature`

Rollback references a non-existent `originalTransactionId`. Casino records a tombstone marker with `amount=0` and returns success.

```json
// Request
{
  "sessionToken": "7f325788-c990-432c-b7b0-7dcbdd4e5101",
  "userId": 1,
  "transactionId": "0e2f778b-1e52-4872-a97c-4c58f759e12e",
  "roundId": "971faf2a-1b1a-45da-82dd-fc1e202134e3",
  "originalTransactionId": "non-existent-tx-id"
}

// Response 200
{
  "transactionId": "0e2f778b-1e52-4872-a97c-4c58f759e12e",
  "balance": "1001000",
  "currency": "USD",
  "status": "ok",
  "tombstone": true
}
```

Balance: **1,001,000** (unchanged — tombstone recorded for auditability)

---

### Step 9: Rollback rejected after payout

**`POST /casino/rollback`** | Header: `x-casino-signature`

Attempts to rollback bet 1, but the round already has a credit (Step 5). Casino rejects with HTTP 400.

```json
// Request
{
  "sessionToken": "7f325788-c990-432c-b7b0-7dcbdd4e5101",
  "userId": 1,
  "transactionId": "f8a1b2c3-4d5e-6f7a-8b9c-0d1e2f3a4b5c",
  "roundId": "971faf2a-1b1a-45da-82dd-fc1e202134e3",
  "originalTransactionId": "a9429bb3-9f71-4497-9fa4-f5f7592a46af"
}

// Response 400
{ "error": "Cannot rollback: round already has a payout" }
```

Balance: **1,001,000** (unchanged — rollback denied)



## Design Decisions

- **Single codebase:** As specified by the test. Both domains remain logically isolated — Casino never writes to Provider tables and vice versa. All cross-domain communication happens through HTTP.
- **PostgreSQL:** Required by the test. BigInt columns store monetary values in cents to avoid floating-point precision issues.
- **Atomic transactions:** All wallet mutations run inside Prisma interactive transactions (`$transaction`). Balance read + update + ledger insert succeed or fail as a unit, preventing partial writes.
- **Idempotency is mandatory:** In gaming and fintech systems, network failures and retries are expected. Without idempotency, a retried debit could double-charge a player. The `external_transaction_id` UNIQUE constraint combined with response caching eliminates this risk entirely.
